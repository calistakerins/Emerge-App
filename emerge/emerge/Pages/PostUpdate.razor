@page "/postupdate"
@using emerge.Data
@using System.ComponentModel.DataAnnotations
@using System.Text
@using System.Net.Mime

@*<DataAnnotationsValidator />*@
<MudMainContent>
    <MudContainer MaxWidth="MaxWidth.Medium">
        <MudButton Variant="Variant.Outlined" Href="/adminprofile">Back</MudButton>
        <MudText Typo="Typo.h3" Class="pb-8 pt-8" Color="Color.Primary">Post Update</MudText>

        <MudCard>
            <MudCardContent>
                <MudTextField Label="Title"
                              @bind-Value="AlertTitle" Variant="Variant.Filled" Class="pt-4 pb-4" />
                <MudTextField T="string" Label="Description" @bind-Value="AlertDescription" Variant="Variant.Filled" Lines="5" Class="pt-4 pb-4" />
            </MudCardContent>
            <MudCardActions>
                <MudButton @onclick="@AddNewsAlert" ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Primary" Class="ml-auto mb-4">Post Update</MudButton>
            </MudCardActions>
        </MudCard>
        <MudText Typo="Typo.h3" Class="mt-5"><b>@success</b></MudText>

    </MudContainer>
</MudMainContent>

@code {

    public DateTime AlertTime = new System.DateTime(2019, 05, 09, 09, 37, 07);
    [Required]
    public string AlertTitle { get; set; }
    public string AlertAuthor = "Dummy";
    [Required]
    public int AlertPriority { get; set; }
    [Required]
    public string AlertDescription { get; set; }
    public string AlertImageUrl { get; set; }

    public UpdateInfo[] updateInfo = new UpdateInfo[0];
    public bool success = false;


    private async Task AddNewsAlert()
    {

        HttpClient client = new HttpClient { BaseAddress = new Uri("https://emerge-app.azurewebsites.net/api/newsalert?") };

        HttpResponseMessage response = null;

        var payload = new AlertInfo(AlertTime, AlertTitle, AlertAuthor, AlertDescription, AlertPriority, updateInfo, AlertImageUrl);

        var payloadString = new StringContent(System.Text.Json.JsonSerializer.Serialize(payload), Encoding.UTF8, MediaTypeNames.Application.Json);

        response = await client.PostAsync(client.BaseAddress, payloadString);

        if (response.IsSuccessStatusCode)
        {
            success = true;
        }
        else
        {
            success = false;
        }
    }

}
